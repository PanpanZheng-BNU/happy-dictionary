{% extends 'base.html' %}
{% block css %}
    <link rel="stylesheet" href="/static/css/result.css">
{% endblock css %}
{% block content %}
    <br>

    <div class="container-fluid" id="translate-button-text-result-div">
        <div class="row-fluid" id="translate-button-row">

            <span class="form-check" id="translate-checkbox">
                <input type="checkbox" class="form-check-input" id="live-translate-check">
                <label class="form-check-label" for="live-translate-check">实时翻译</label>
            </span>

            <span id="translate-button">
                <input type="button" class="btn btn-outline-primary" value="translate">
            </span>
        </div>

        <div class="row-fluid" id="translate-text-result-row">

            <span id="translate-text-span">
                 <form id="translate-text">
                     {{ form }}
                 </form>
            </span>

            <span id="translate-result-span">
                <div id="picture-display-div" style="background-color:red;"></div>
                <div id="translate-result-div">
                <table id="translate-result">
                    <caption>Translate Result</caption>
                    <tbody></tbody>
                </table>
                    </div>
            </span>
        </div>

    </div>



{% endblock content %}




{% block javascript %}
    <script>
        $("#translate-button").click(function (e) {
            var translateText = $("#translate_text2").val();
            $.ajax({
                type: 'GET',
                url: "{% url 'translate_ajax' %}",
                data: {"translateText": translateText},
                success: function (response) {
                    var instance = JSON.parse(response["forjson"]);
                    var picUrl = JSON.parse(response["picUrl"]);

                    presentResult(translateText, instance, picUrl);
                }
            });
        })

        function check() {
            return $("#live-translate-check").is(':checked');
        };


        function presentResult(getText, result, urlRes) {
            $("#translate-result tbody").empty();
            $("#picture-display-div").empty();

            if (getText.length != 0) {
                if (result['dict'].hasOwnProperty("acceptation")) {
                    let acceptationArray = result['dict']['acceptation'];
                    let posArray = result['dict']['pos'];
                    let posAcceptation;
                    if (typeof (acceptationArray) == "object") {
                        let pos
                        let acceptation
                        for (i in acceptationArray) {
                            if (posArray[i] != null) {
                                pos = `<h1 class="pos">${posArray[i]}</h1>`
                            }
                            $("#translate-result tbody").append(`${pos}`);


                            for (acceptation of acceptationArray[i].split("；")) {
                                if (acceptation.length != 0) {
                                    $("#translate-result tbody").append(`<p class="acceptation">${acceptation}; </p>`);
                                }
                            }
                        }
                    } else {
                        if (posArray != null) {
                            $("#translate-result tbody").append(`<h1 class="pos">${posArray}</h1>`)
                            for (acceptation of acceptationArray.split("；")) {
                                if (acceptation.length != 0) {
                                    $("#translate-result tbody").append(`<p class="acceptation">${acceptation}; </p>`);
                                }
                            }
                        } else {
                            for (acceptation of acceptationArray.split("；")) {
                                if (acceptation.length != 0) {
                                    $("#translate-result tbody").append(`<p class="acceptation">${acceptation}; </p>`);
                                }
                            }
                        }
                        $("#translate-result tbody").append(`<tr>${posAcceptation}</tr>`);
                    }

                    $("#picture-display-div").append(
                        `<img id="picture" src=${urlRes['url'][0]} width="100%"/>`
                    )
                } else {
                    $("#translate-result tbody").append(`<tr><td>抱歉，啥也没找到，请输入英文单词</td></tr>`);
                }
            }
        }

        $(function () {
            var instance = {{ forjson|safe }};
            var firstTranslate = {{ getText2|safe }};
            var picUrl = {{ picUrl|safe }}

                $("#translate_text2").val(firstTranslate);
            presentResult("first", instance, picUrl);
        })

        $("#live-translate-check").change(function (e) {
            e.preventDefault();
            if (check() == true) {
                var translateText = $("#translate_text2").val();
                $.ajax({
                    type: 'GET',
                    url: "{% url 'translate_ajax' %}",
                    data: {"translateText": translateText},
                    success: function (response) {
                        var instance = JSON.parse(response["forjson"]);
                        var picUrl = JSON.parse(response["picUrl"]);
                        presentResult(translateText, instance, picUrl);
                    }
                });

                var queue = 0;
                $("#translate_text2").on('keyup', function (event) {
                    var check_status = check();
                    if (check_status == true) {
                        clearTimeout(queue);
                        queue = setTimeout(function () {
                            var translateText = $("#translate_text2").val();
                            $.ajax({
                                type: 'GET',
                                url: "{% url 'translate_ajax' %}",
                                data: {"translateText": translateText},
                                success: function (response) {
                                    var instance = JSON.parse(response["forjson"]);
                                    var picUrl = JSON.parse(response["picUrl"])
                                    presentResult(translateText, instance, picUrl);
                                }
                            })
                        }, 400);
                    }

                })
            }
        });

    </script>
{% endblock javascript %}
